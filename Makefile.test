# Gripmock Test Makefile

# Test Variables
TEST_VERSION=test
LOCAL_PLATFORM=linux/arm64/v8

.PHONY: test-simple test-advanced test-well-known-types test-stub-subfolders test-stream test-one-of test-multi-package test-multi-files build-test-image clean-protogen

# Optional: Build test image
build-test-image:
	docker buildx build --load -t $(DOCKER_IMAGE):$(TEST_VERSION) --platform $(LOCAL_PLATFORM) .

# Clean generated protobuf files
clean-protogen:
	@echo "Cleaning generated protobuf files..."
	@find . -name "*.pb.go" -type f -delete
	@echo "Cleaned all .pb.go files recursively"

# Run simple example test
test-simple: clean-protogen
	@echo "Starting gripmock container for simple test..."
	@docker rm -f gripmock-test || true
	docker run -d --name gripmock-test \
		-v ./protogen:/go/src/github.com/tokopedia/gripmock/protogen \
		--entrypoint=example/simple/entrypoint.sh \
		$(DOCKER_IMAGE):$(TEST_VERSION) 
	@echo "Waiting for server to start..."
	@sleep 3
	@echo "Container logs:"
	@docker logs gripmock-test
	@echo "Cleaning up..."
	@docker rm -f gripmock-test

# Run advanced example test
test-advanced: clean-protogen
	@echo "Starting gripmock container for advanced test..."
	@docker rm -f gripmock-test || true
	docker run -d --name gripmock-test \
		-v ./protogen:/go/src/github.com/tokopedia/gripmock/protogen \
		--entrypoint=example/advanced/entrypoint.sh \
		$(DOCKER_IMAGE):$(TEST_VERSION) 
	@echo "Waiting for server to start..."
	@sleep 3
	@echo "Container logs:"
	@docker logs gripmock-test
	@echo "Cleaning up..."
	@docker rm -f gripmock-test

# Run well-known types example test
test-well-known-types: clean-protogen
	@echo "Starting gripmock container for well-known types test..."
	@docker rm -f gripmock-test || true
	docker run -d --name gripmock-test \
		-v ./protogen:/go/src/github.com/tokopedia/gripmock/protogen \
		--entrypoint=example/well_known_types/entrypoint.sh \
		$(DOCKER_IMAGE):$(TEST_VERSION) 
	@echo "Waiting for server to start..."
	@sleep 3
	@echo "Container logs:"
	@docker logs gripmock-test
	@echo "Cleaning up..."
	@docker rm -f gripmock-test

# Run stub subfolders example test
test-stub-subfolders: clean-protogen
	@echo "Starting gripmock container for stub subfolders test..."
	@docker rm -f gripmock-test || true
	docker run -d --name gripmock-test \
		-v ./protogen:/go/src/github.com/tokopedia/gripmock/protogen \
		--entrypoint=example/stub-subfolders/entrypoint.sh \
		$(DOCKER_IMAGE):$(TEST_VERSION) 
	@echo "Waiting for server to start..."
	@sleep 3
	@echo "Container logs:"
	@docker logs gripmock-test
	@echo "Cleaning up..."
	@docker rm -f gripmock-test

# Run stream example test
test-stream: clean-protogen
	@echo "Starting gripmock container for stream test..."
	@docker rm -f gripmock-test || true
	docker run -d --name gripmock-test \
		-v ./protogen:/go/src/github.com/tokopedia/gripmock/protogen \
		--entrypoint=example/stream/entrypoint.sh \
		$(DOCKER_IMAGE):$(TEST_VERSION) 
	@echo "Waiting for server to start..."
	@sleep 3
	@echo "Container logs:"
	@docker logs gripmock-test
	@echo "Cleaning up..."
	@docker rm -f gripmock-test

# Run one-of example test
test-one-of: clean-protogen
	@echo "Starting gripmock container for one-of test..."
	@docker rm -f gripmock-test || true
	docker run -d --name gripmock-test \
		-v ./protogen:/go/src/github.com/tokopedia/gripmock/protogen \
		--entrypoint=example/one-of/entrypoint.sh \
		$(DOCKER_IMAGE):$(TEST_VERSION) 
	@echo "Waiting for server to start..."
	@sleep 3
	@echo "Container logs:"
	@docker logs gripmock-test
	@echo "Cleaning up..."
	@docker rm -f gripmock-test

# Run multi-package example test
test-multi-package: clean-protogen
	@echo "Starting gripmock container for multi-package test..."
	@docker rm -f gripmock-test || true
	docker run -d --name gripmock-test \
		-v ./protogen:/go/src/github.com/tokopedia/gripmock/protogen \
		--entrypoint=example/multi-package/entrypoint.sh \
		$(DOCKER_IMAGE):$(TEST_VERSION) 
	@echo "Waiting for server to start..."
	@sleep 3
	@echo "Container logs:"
	@docker logs gripmock-test
	@echo "Cleaning up..."
	@docker rm -f gripmock-test

# Run multi-files example test
test-multi-files: clean-protogen
	@echo "Starting gripmock container for multi-files test..."
	@docker rm -f gripmock-test || true
	docker run -d --name gripmock-test \
		-v ./protogen:/go/src/github.com/tokopedia/gripmock/protogen \
		--entrypoint=example/multi-files/entrypoint.sh \
		$(DOCKER_IMAGE):$(TEST_VERSION) 
	@echo "Waiting for server to start..."
	@sleep 3
	@echo "Container logs:"
	@docker logs gripmock-test
	@echo "Cleaning up..."
	@docker rm -f gripmock-test

# Run all tests
test-all: test-simple test-advanced test-well-known-types test-stub-subfolders test-stream test-one-of test-multi-package test-multi-files 